---
// src/components/store/Tienda.astro
import { ShoppingBag } from 'lucide-astro';
import ProductModal from './ProductModal.astro';
import { products } from '../../data/products';
---

<section class="py-16 md:py-24 px-4 bg-brand-bg relative overflow-hidden">
    <div class="absolute inset-0 bg-[linear-gradient(to_right,#262626_1px,transparent_1px),linear-gradient(to_bottom,#262626_1px,transparent_1px)] bg-[size:4rem_4rem] opacity-[0.05] -z-10"></div>
    <div class="absolute bottom-0 left-0 w-[500px] h-[500px] bg-brand-blue/10 rounded-full blur-[120px] -z-10"></div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="text-center mb-12 md:mb-16">
      <h1 class="text-4xl md:text-6xl font-display font-black text-white uppercase tracking-tighter leading-tight">
        Tienda <span class="text-brand-blue">Oficial</span>
      </h1>
      <p class="text-brand-muted text-lg md:text-xl font-sans mt-4 max-w-2xl mx-auto">
        Equipación y ropa de alta calidad para el entrenamiento y tu día a día.
      </p>
    </div>

    <div id="store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">
      {products.map((product) => (
        <div class="product-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black cursor-pointer"
             data-name={product.name}
             data-price={product.price}
             data-image={product.imageUrl}
             data-description={product.description}>
          <div class="relative">
            <img src={product.imageUrl} alt={product.name} class="w-full h-80 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" />
            <div class="absolute top-4 left-4 bg-black/50 text-white text-xs font-bold px-3 py-1 rounded-full">{product.category}</div>
          </div>
          <div class="p-6 text-center">
            <h3 class="text-lg font-display font-bold text-white mb-2">{product.name}</h3>
            <p class="text-brand-blue font-sans font-black text-2xl mb-4">{product.price}</p>
            <button class="add-to-cart-btn w-full inline-flex items-center justify-center gap-2 bg-brand-blue text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider text-sm">
                <ShoppingBag class="w-4 h-4" />
              Añadir al carrito
            </button>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<div class="store-cart fixed bottom-6 right-6 z-40">
  <button class="cart-toggle flex items-center gap-3 bg-brand-blue text-white px-5 py-3 rounded-full font-bold shadow-2xl shadow-black/40 hover:bg-blue-600 transition-all duration-300">
    <ShoppingBag class="w-5 h-5" />
    <span>Carrito</span>
    <span id="cart-count" class="ml-1 inline-flex items-center justify-center min-w-[24px] h-6 px-2 text-xs rounded-full bg-black/40">0</span>
  </button>
</div>

<aside id="store-cart-panel" class="cart-panel fixed right-4 bottom-24 z-40 w-[360px] max-w-[92vw] bg-brand-card border border-brand-border rounded-3xl p-5 shadow-2xl shadow-black/40 opacity-0 pointer-events-none translate-y-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-white font-display font-bold uppercase tracking-wider text-lg">Tu carrito</h3>
    <button id="close-cart" class="text-brand-muted hover:text-white transition-colors text-sm">Cerrar</button>
  </div>

  <div id="cart-items" class="space-y-3 max-h-[320px] overflow-auto pr-1"></div>

  <div class="mt-5 pt-4 border-t border-brand-border flex items-center justify-between">
    <span class="text-brand-muted font-sans text-sm">Total</span>
    <span id="cart-total" class="text-white font-sans font-black text-xl">0.00€</span>
  </div>

  <button class="mt-4 w-full bg-white text-black font-bold uppercase tracking-wider text-sm py-3 rounded-xl hover:bg-brand-blue hover:text-white transition-all duration-300">
    Finalizar compra
  </button>
</aside>

<ProductModal />

<script>
  const runStoreHydration = () => {
    const productCards = document.querySelectorAll('.product-card');
    const modal = document.getElementById('product-modal') as HTMLElement;
    const modalImage = document.getElementById('modal-image') as HTMLImageElement;
    const modalName = document.getElementById('modal-name') as HTMLElement;
    const modalPrice = document.getElementById('modal-price') as HTMLElement;
    const modalDescription = document.getElementById('modal-description') as HTMLElement;

    function openModal(card: Element) {
      modalImage.src = card.getAttribute('data-image') || '';
      modalName.textContent = card.getAttribute('data-name') || '';
      modalPrice.textContent = card.getAttribute('data-price') || '';
      modalDescription.textContent = card.getAttribute('data-description') || '';

      modal.setAttribute('data-name', card.getAttribute('data-name') || '');
      modal.setAttribute('data-price', card.getAttribute('data-price') || '');
      modal.setAttribute('data-image', card.getAttribute('data-image') || '');
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      window.dispatchEvent(new CustomEvent('modal:open'));
    }

    const cartToggle = document.querySelector('.cart-toggle') as HTMLButtonElement;
    const cartPanel = document.getElementById('store-cart-panel') as HTMLElement;
    const closeCartBtn = document.getElementById('close-cart') as HTMLButtonElement;
    const cartCount = document.getElementById('cart-count') as HTMLElement;
    const cartItems = document.getElementById('cart-items') as HTMLElement;
    const cartTotal = document.getElementById('cart-total') as HTMLElement;

    type CartItem = {
      id: number;
      name: string;
      price: string;
      image: string;
    };

    const cart: CartItem[] = [];
    let lastAddedId: number | null = null;

    function parsePrice(price: string) {
      const numeric = price.replace('€', '').replace(',', '.').trim();
      return Number.parseFloat(numeric) || 0;
    }

    function formatPrice(value: number) {
      return value.toFixed(2) + '€';
    }

    function renderCart() {
      if (cart.length === 0) {
        cartItems.innerHTML = `
          <div class="text-brand-muted text-sm font-sans bg-black/20 rounded-2xl p-4 text-center">
            Tu carrito esta vacio. Anade algo para verlo aqui.
          </div>
        `;
        cartTotal.textContent = formatPrice(0);
        cartCount.textContent = '0';
        return;
      }

      cartItems.innerHTML = cart
        .map((item) => {
          const isNew = lastAddedId === item.id;
          return `
            <div class="cart-item flex items-center gap-3 bg-black/20 rounded-2xl p-3 ${isNew ? 'item-pop' : ''}">
              <img src="${item.image}" alt="${item.name}" class="w-14 h-14 rounded-xl object-cover" />
              <div class="flex-1">
                <p class="text-white text-sm font-bold">${item.name}</p>
                <p class="text-brand-muted text-xs">${item.price}</p>
              </div>
            </div>
          `;
        })
        .join('');

      const total = cart.reduce((sum, item) => sum + parsePrice(item.price), 0);
      cartTotal.textContent = formatPrice(total);
      cartCount.textContent = String(cart.length);
    }

    function bumpCart() {
      cartPanel.classList.add('cart-bump');
      window.setTimeout(() => cartPanel.classList.remove('cart-bump'), 400);
    }

    function addToCart(card: Element) {
      const item: CartItem = {
        id: Date.now(),
        name: card.getAttribute('data-name') || 'Producto',
        price: card.getAttribute('data-price') || '0.00€',
        image: card.getAttribute('data-image') || '',
      };
      lastAddedId = item.id;
      cart.push(item);
      renderCart();
      cartPanel.classList.add('is-open');
      bumpCart();
    }

    function toggleCart(open: boolean) {
      if (open) {
        cartPanel.classList.add('is-open');
      } else {
        cartPanel.classList.remove('is-open');
      }
    }

    cartToggle.addEventListener('click', () => {
      const open = !cartPanel.classList.contains('is-open');
      toggleCart(open);
    });

    closeCartBtn.addEventListener('click', () => toggleCart(false));

    window.addEventListener('cart:add', (event) => {
      const detail = (event as CustomEvent).detail as { name: string; price: string; image: string };
      const item: CartItem = {
        id: Date.now(),
        name: detail.name || 'Producto',
        price: detail.price || '0.00€',
        image: detail.image || '',
      };
      lastAddedId = item.id;
      cart.push(item);
      renderCart();
      cartPanel.classList.add('is-open');
      bumpCart();
    });

    function bindCard(card: Element) {
      const addBtn = card.querySelector('.add-to-cart-btn') as HTMLButtonElement;
      if (addBtn) {
        addBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          addToCart(card);
        });
      }

      card.addEventListener('click', (e) => {
        if ((e.target as HTMLElement).closest('.add-to-cart-btn')) {
          return;
        }
        openModal(card);
      });
    }

    productCards.forEach(bindCard);

    const gridEl = document.getElementById('store-grid');
    if (gridEl) {
      const devProducts = JSON.parse(localStorage.getItem('hitro_products_dev') || '[]');
      devProducts.forEach((product: { name: string; price: string; imageUrl: string; category: string; description: string }) => {
        const card = document.createElement('div');
        card.className = 'product-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black cursor-pointer';
        card.setAttribute('data-name', product.name || '');
        card.setAttribute('data-price', product.price || '');
        card.setAttribute('data-image', product.imageUrl || '');
        card.setAttribute('data-description', product.description || '');

        card.innerHTML = `
          <div class="relative">
            <img src="${product.imageUrl || ''}" alt="${product.name || ''}" class="w-full h-80 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" />
            <div class="absolute top-4 left-4 bg-black/50 text-white text-xs font-bold px-3 py-1 rounded-full">${product.category || ''}</div>
          </div>
          <div class="p-6 text-center">
            <h3 class="text-lg font-display font-bold text-white mb-2">${product.name || ''}</h3>
            <p class="text-brand-blue font-sans font-black text-2xl mb-4">${product.price || ''}</p>
            <button class="add-to-cart-btn w-full inline-flex items-center justify-center gap-2 bg-brand-blue text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider text-sm">
              Añadir al carrito
            </button>
          </div>
        `;

        gridEl.appendChild(card);
        bindCard(card);
      });
    }

    renderCart();
  };

  document.addEventListener('astro:page-load', runStoreHydration);
  document.addEventListener('DOMContentLoaded', runStoreHydration);
  window.addEventListener('storage', (e) => {
    if (e.key === 'hitro_products_dev') {
      runStoreHydration();
    }
  });
</script>

<style>
  .cart-panel.is-open {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  .cart-bump {
    animation: cart-bump 0.4s ease;
  }

  .item-pop {
    animation: item-pop 0.35s ease;
  }

  @keyframes cart-bump {
    0% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-4px) scale(1.02); }
    100% { transform: translateY(0) scale(1); }
  }

  @keyframes item-pop {
    0% { transform: translateY(6px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }
</style>
