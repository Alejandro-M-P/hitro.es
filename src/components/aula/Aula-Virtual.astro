---
// src/components/aula/Aula-Virtual.astro
import { lessons } from '../../data/lessons';
import { Image } from 'astro:assets';
---

<section class="py-16 md:py-24 px-4 bg-brand-bg relative overflow-hidden">
  <div class="absolute inset-0 bg-[linear-gradient(to_right,#262626_1px,transparent_1px),linear-gradient(to_bottom,#262626_1px,transparent_1px)] bg-[size:4rem_4rem] opacity-[0.05] -z-10"></div>
  <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-brand-blue/10 rounded-full blur-[120px] -z-10"></div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="text-center mb-12 md:mb-16">
      <h1 class="text-4xl md:text-6xl font-display font-black text-white uppercase tracking-tighter leading-tight">
        Aula <span class="text-brand-blue">Virtual</span>
      </h1>
      <p class="text-brand-muted text-lg md:text-xl font-sans mt-4 max-w-2xl mx-auto">
        Recursos exclusivos para miembros. Repasa técnicas, tácticas y mejora tu mentalidad.
      </p>
    </div>

    <div id="aula-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {lessons.map((lesson) => (
        <a
          href={`/aula/${lesson.slug}`}
          class="video-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black"
          data-slug={lesson.slug}
          data-title={lesson.title}
          data-description={lesson.description}
          data-youtube={lesson.youtubeId}
          data-image={lesson.imageUrl}
          data-category={lesson.category}
          data-duration={lesson.duration}
        >
          <div class="relative">
            <Image src={lesson.imageUrl} alt={lesson.title} class="w-full h-48 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" width={800} height={450} loading="lazy" />
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            <div class="absolute top-4 right-4 bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-full">{lesson.duration}</div>
            <div class="absolute bottom-4 left-4 flex items-center gap-2">
              <div class="w-10 h-10 bg-brand-blue text-white rounded-full flex items-center justify-center">
                <lesson.icon class="w-5 h-5" />
              </div>
            </div>
             <div class="absolute bottom-4 right-4 flex items-center gap-2">
                 <span class="text-brand-blue font-sans font-semibold text-xs uppercase tracking-widest">{lesson.category}</span>
            </div>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-display font-bold text-white mb-2">{lesson.title}</h3>
          </div>
        </a>
      ))}
    </div>

    <div id="aula-skeleton" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8 mt-6">
      {Array.from({ length: 3 }).map(() => (
        <div class="bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden animate-pulse">
          <div class="w-full h-48 bg-black/30"></div>
          <div class="p-6 space-y-3">
            <div class="h-6 bg-black/30 rounded-lg"></div>
            <div class="h-6 bg-black/30 rounded-lg w-2/3"></div>
          </div>
        </div>
      ))}
    </div>
  </div>
</section>

<div id="video-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="bg-brand-card border border-brand-border rounded-[2rem] max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 p-8 relative animate-fade-in">
    <button id="close-video-modal" class="absolute top-4 right-4 text-brand-muted hover:text-white transition-colors">✕</button>
    <div class="w-full aspect-video bg-black/50 rounded-2xl overflow-hidden">
      <iframe id="video-iframe" class="w-full h-full" src="" title="Video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
    <div class="flex flex-col justify-center">
      <h2 id="video-title" class="text-3xl font-display font-black text-white uppercase"></h2>
      <p id="video-meta" class="text-brand-blue text-sm font-bold uppercase tracking-wider my-3"></p>
      <p id="video-description" class="text-brand-muted font-sans text-base leading-relaxed mb-6"></p>
      <a id="video-link" href="#" target="_blank" class="w-full inline-flex items-center justify-center gap-2 bg-brand-blue text-white px-6 py-4 rounded-xl font-bold hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider">
        Ver en YouTube
      </a>
    </div>
  </div>
</div>

<script id="base-lessons-data" type="application/json" set:html={JSON.stringify(lessons)}></script>
<script>
  import { useCourses } from '../../hooks/useCourses';
  import { useToast } from '../../hooks/useToast';
  import type { LessonVideo } from '../../types/domain';

  let model: ReturnType<typeof useCourses> | null = null;
  const toast = useToast();
  let onStorageChange: ((event: StorageEvent) => void) | null = null;
  let onEscape: ((event: KeyboardEvent) => void) | null = null;

  function getBaseLessons(): LessonVideo[] {
    const raw = document.getElementById('base-lessons-data')?.textContent || '[]';
    try {
      return JSON.parse(raw) as LessonVideo[];
    } catch {
      return [];
    }
  }

  function buildVideoCard(lesson: LessonVideo & { isLocked: boolean }, index: number): string {
    return `
      <a
        href="${lesson.isLocked ? '#' : `/aula/${lesson.slug}`}"
        class="video-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black ${lesson.isLocked ? 'opacity-80' : ''}"
        data-index="${index}"
        data-locked="${lesson.isLocked ? 'true' : 'false'}"
        data-title="${lesson.title || ''}"
        data-description="${lesson.description || ''}"
        data-youtube="${lesson.youtubeId || ''}"
        data-category="${lesson.category || ''}"
        data-duration="${lesson.duration || ''}"
        data-slug="${lesson.slug || ''}"
      >
        <div class="relative">
          <img src="${lesson.imageUrl || ''}" alt="${lesson.title || ''}" class="w-full h-48 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" loading="lazy" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
          <div class="absolute top-4 right-4 bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-full">${lesson.duration || ''}</div>
          ${
            lesson.isLocked
              ? '<div class="absolute top-4 left-4 bg-black/70 text-brand-blue text-xs font-bold px-2 py-1 rounded-full border border-brand-border">Bloqueado</div>'
              : '<div class="absolute top-4 left-4 bg-brand-blue/20 text-brand-blue text-xs font-bold px-2 py-1 rounded-full border border-brand-blue/40">Desbloqueado</div>'
          }
          <div class="absolute bottom-4 left-4 flex items-center gap-2">
            <div class="w-10 h-10 bg-brand-blue text-white rounded-full flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polygon points="10 8 16 12 10 16 10 8"></polygon>
              </svg>
            </div>
          </div>
          <div class="absolute bottom-4 right-4 flex items-center gap-2">
            <span class="text-brand-blue font-sans font-semibold text-xs uppercase tracking-widest">${lesson.category || ''}</span>
          </div>
        </div>
        <div class="p-6">
          <h3 class="text-xl font-display font-bold text-white mb-2">${lesson.title || ''}</h3>
        </div>
      </a>
    `;
  }

  function closeModal(modal: HTMLElement, iframe: HTMLIFrameElement): void {
    iframe.src = '';
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  function openModal(card: HTMLElement): void {
    const modal = document.getElementById('video-modal') as HTMLElement | null;
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement | null;
    const titleEl = document.getElementById('video-title') as HTMLElement | null;
    const metaEl = document.getElementById('video-meta') as HTMLElement | null;
    const descEl = document.getElementById('video-description') as HTMLElement | null;
    const linkEl = document.getElementById('video-link') as HTMLAnchorElement | null;
    if (!modal || !iframe || !titleEl || !metaEl || !descEl || !linkEl) return;

    const title = card.getAttribute('data-title') || '';
    const description = card.getAttribute('data-description') || '';
    const youtubeId = card.getAttribute('data-youtube') || '';
    const category = card.getAttribute('data-category') || '';
    const duration = card.getAttribute('data-duration') || '';
    const slug = card.getAttribute('data-slug') || '';

    titleEl.textContent = title;
    descEl.textContent = description;
    metaEl.textContent = `${category} · ${duration}`;
    iframe.src = youtubeId ? `https://www.youtube.com/embed/${youtubeId}` : '';
    linkEl.href = slug ? `/aula/${slug}` : '#';
    linkEl.textContent = 'Ir a la leccion';

    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function bindCards(gridEl: HTMLElement): void {
    gridEl.querySelectorAll('.video-card').forEach((card) => {
      card.addEventListener('click', (event) => {
        const current = card as HTMLElement;
        if (current.dataset.locked === 'true') {
          event.preventDefault();
          toast.info('Leccion bloqueada. Completa las anteriores para desbloquearla.');
          return;
        }

        event.preventDefault();
        openModal(current);
      });
    });
  }

  async function hydrateAula(): Promise<void> {
    const gridEl = document.getElementById('aula-grid') as HTMLElement | null;
    const skeletonEl = document.getElementById('aula-skeleton') as HTMLElement | null;
    if (!gridEl) return;

    skeletonEl?.classList.remove('hidden');
    gridEl.classList.add('opacity-0');

    model = useCourses(getBaseLessons());
    await model.load();
    gridEl.innerHTML = model.lessons.map((lesson, index) => buildVideoCard(lesson, index)).join('');
    bindCards(gridEl);

    skeletonEl?.classList.add('hidden');
    gridEl.classList.remove('opacity-0');
  }

  async function runAulaHydration(): Promise<void> {
    await hydrateAula();

    const modal = document.getElementById('video-modal') as HTMLElement | null;
    const closeBtn = document.getElementById('close-video-modal') as HTMLButtonElement | null;
    const iframe = document.getElementById('video-iframe') as HTMLIFrameElement | null;
    if (!modal || !closeBtn || !iframe) return;

    closeBtn.onclick = () => closeModal(modal, iframe);
    modal.onclick = (event: MouseEvent) => {
      if (event.target === modal) closeModal(modal, iframe);
    };

    if (onEscape) {
      document.removeEventListener('keydown', onEscape);
    }
    onEscape = (event: KeyboardEvent) => {
      if (event.key === 'Escape') closeModal(modal, iframe);
    };
    document.addEventListener('keydown', onEscape);

    if (onStorageChange) {
      window.removeEventListener('storage', onStorageChange);
    }
    onStorageChange = async (event: StorageEvent) => {
      if (event.key !== 'hitro_videos_dev') return;
      await hydrateAula();
    };
    window.addEventListener('storage', onStorageChange);
  }

  document.addEventListener('astro:page-load', runAulaHydration);
  document.addEventListener('DOMContentLoaded', runAulaHydration);
</script>
