---
// src/components/aula/Aula-Virtual.astro
import { lessons } from '../../data/lessons';
import { Image } from 'astro:assets';
---

<section class="py-16 md:py-24 px-4 bg-brand-bg relative overflow-hidden">
  <div class="absolute inset-0 bg-[linear-gradient(to_right,#262626_1px,transparent_1px),linear-gradient(to_bottom,#262626_1px,transparent_1px)] bg-[size:4rem_4rem] opacity-[0.05] -z-10"></div>
  <div class="absolute top-0 right-0 w-[500px] h-[500px] bg-brand-blue/10 rounded-full blur-[120px] -z-10"></div>

  <div class="max-w-7xl mx-auto relative z-10">
    <div class="text-center mb-12 md:mb-16">
      <h1 class="text-4xl md:text-6xl font-display font-black text-white uppercase tracking-tighter leading-tight">
        Aula <span class="text-brand-blue">Virtual</span>
      </h1>
      <p class="text-brand-muted text-lg md:text-xl font-sans mt-4 max-w-2xl mx-auto">
        Recursos exclusivos para miembros. Repasa técnicas, tácticas y mejora tu mentalidad.
      </p>
    </div>

    <div id="aula-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      {lessons.map((lesson) => (
        <a
          href={`/aula/${lesson.slug}`}
          class="video-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black"
          data-title={lesson.title}
          data-description={lesson.description}
          data-youtube={lesson.youtubeId}
          data-image={lesson.imageUrl}
          data-category={lesson.category}
          data-duration={lesson.duration}
        >
          <div class="relative">
            <Image src={lesson.imageUrl} alt={lesson.title} class="w-full h-48 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" width={800} height={450} loading="lazy" />
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            <div class="absolute top-4 right-4 bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-full">{lesson.duration}</div>
            <div class="absolute bottom-4 left-4 flex items-center gap-2">
              <div class="w-10 h-10 bg-brand-blue text-white rounded-full flex items-center justify-center">
                <lesson.icon class="w-5 h-5" />
              </div>
            </div>
             <div class="absolute bottom-4 right-4 flex items-center gap-2">
                 <span class="text-brand-blue font-sans font-semibold text-xs uppercase tracking-widest">{lesson.category}</span>
            </div>
          </div>
          <div class="p-6">
            <h3 class="text-xl font-display font-bold text-white mb-2">{lesson.title}</h3>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>

<div id="video-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
  <div class="bg-brand-card border border-brand-border rounded-[2rem] max-w-4xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 p-8 relative animate-fade-in">
    <button id="close-video-modal" class="absolute top-4 right-4 text-brand-muted hover:text-white transition-colors">✕</button>
    <div class="w-full aspect-video bg-black/50 rounded-2xl overflow-hidden">
      <iframe id="video-iframe" class="w-full h-full" src="" title="Video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
    <div class="flex flex-col justify-center">
      <h2 id="video-title" class="text-3xl font-display font-black text-white uppercase"></h2>
      <p id="video-meta" class="text-brand-blue text-sm font-bold uppercase tracking-wider my-3"></p>
      <p id="video-description" class="text-brand-muted font-sans text-base leading-relaxed mb-6"></p>
      <a id="video-link" href="#" target="_blank" class="w-full inline-flex items-center justify-center gap-2 bg-brand-blue text-white px-6 py-4 rounded-xl font-bold hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider">
        Ver en YouTube
      </a>
    </div>
  </div>
</div>

<script>
  const runAulaHydration = () => {
    const gridEl = document.getElementById('aula-grid');
    if (!gridEl) return;

    const devVideos = JSON.parse(localStorage.getItem('hitro_videos_dev') || '[]');
    devVideos.forEach((video: { title: string; category: string; youtubeId: string; duration: string; imageUrl: string; description: string }) => {
      const card = document.createElement('a');
      card.href = '#';
      card.className = 'video-card bg-brand-card border border-brand-border rounded-[2rem] overflow-hidden group transition-all duration-300 hover:border-brand-blue hover:-translate-y-2 hover:shadow-2xl shadow-black';
      card.setAttribute('data-title', video.title || '');
      card.setAttribute('data-description', video.description || '');
      card.setAttribute('data-youtube', video.youtubeId || '');
      card.setAttribute('data-image', video.imageUrl || '');
      card.setAttribute('data-category', video.category || '');
      card.setAttribute('data-duration', video.duration || '');

      card.innerHTML = `
        <div class="relative">
          <img src="${video.imageUrl || ''}" alt="${video.title || ''}" class="w-full h-48 object-cover grayscale group-hover:grayscale-0 transition-all duration-500" loading="lazy" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
          <div class="absolute top-4 right-4 bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-full">${video.duration || ''}</div>
          <div class="absolute bottom-4 right-4 flex items-center gap-2">
            <span class="text-brand-blue font-sans font-semibold text-xs uppercase tracking-widest">${video.category || ''}</span>
          </div>
        </div>
        <div class="p-6">
          <h3 class="text-xl font-display font-bold text-white mb-2">${video.title || ''}</h3>
        </div>
      `;

      gridEl.appendChild(card);
    });
  };

  const bindVideoCards = () => {
    const cards = document.querySelectorAll('.video-card');
    const modal = document.getElementById('video-modal');
    const closeBtn = document.getElementById('close-video-modal');
    const iframe = document.getElementById('video-iframe');
    const titleEl = document.getElementById('video-title');
    const metaEl = document.getElementById('video-meta');
    const descEl = document.getElementById('video-description');
    const linkEl = document.getElementById('video-link');

    if (!modal || !iframe || !titleEl || !metaEl || !descEl || !linkEl) return;

    function openModal(card) {
      const title = card.getAttribute('data-title') || '';
      const description = card.getAttribute('data-description') || '';
      const youtubeId = card.getAttribute('data-youtube') || '';
      const category = card.getAttribute('data-category') || '';
      const duration = card.getAttribute('data-duration') || '';

      titleEl.textContent = title;
      descEl.textContent = description;
      metaEl.textContent = `${category} · ${duration}`;
      iframe.src = youtubeId ? `https://www.youtube.com/embed/${youtubeId}` : '';
      linkEl.href = youtubeId ? `https://www.youtube.com/watch?v=${youtubeId}` : '#';

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModal() {
      iframe.src = '';
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    cards.forEach((card) => {
      card.addEventListener('click', (e) => {
        e.preventDefault();
        openModal(card);
      });
    });

    closeBtn?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  };

  document.addEventListener('astro:page-load', runAulaHydration);
  document.addEventListener('DOMContentLoaded', runAulaHydration);
  window.addEventListener('storage', (e) => {
    if (e.key === 'hitro_videos_dev') {
      runAulaHydration();
    }
  });

  document.addEventListener('astro:page-load', bindVideoCards);
  document.addEventListener('DOMContentLoaded', bindVideoCards);
</script>
