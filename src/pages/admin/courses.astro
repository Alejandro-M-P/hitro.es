---
// src/pages/admin/courses.astro
import Layout from '../../layouts/Layout.astro';
import { lessons } from '../../data/lessons';

export const prerender = false;

const session = Astro.cookies.get('session');
const isDev = import.meta.env.DEV;

if (!isDev && session?.value !== 'admin') {
  return Astro.redirect('/admin/login');
}
---

<Layout title="Gestionar Cursos | HITRO">
  <main class="py-12 bg-brand-bg min-h-screen">
    <div class="max-w-4xl mx-auto px-4">
      <a href="/admin" class="text-brand-muted hover:text-white inline-block mb-6">&larr; Volver al panel</a>
      <h1 class="text-4xl font-display font-black text-white uppercase mb-8">Gestionar cursos</h1>

      <form id="add-course-form" class="bg-brand-card border border-brand-border rounded-[2rem] p-8 mb-12">
        <h2 class="text-2xl font-display font-bold text-white mb-6">Agregar nuevo curso</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="title" class="block text-brand-muted font-sans text-sm mb-2">Titulo del curso</label>
            <input type="text" id="title" name="title" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div>
            <label for="price" class="block text-brand-muted font-sans text-sm mb-2">Precio (ejemplo: 49.99€)</label>
            <input type="text" id="price" name="price" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div>
            <label for="category" class="block text-brand-muted font-sans text-sm mb-2">Categoria</label>
            <select id="category" name="category" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
              <option value="Formacion Especializada · Metodo HITRO Adultos">Formacion Especializada · Metodo HITRO Adultos</option>
              <option value="Formacion Especializada · Metodo HITRO Femenino">Formacion Especializada · Metodo HITRO Femenino</option>
              <option value="Formacion Especializada · Metodo HITRO Infantil">Formacion Especializada · Metodo HITRO Infantil</option>
            </select>
          </div>
          <div>
            <label for="slug" class="block text-brand-muted font-sans text-sm mb-2">Slug</label>
            <input type="text" id="slug" name="slug" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div>
            <label for="youtubeId" class="block text-brand-muted font-sans text-sm mb-2">ID de YouTube</label>
            <input type="text" id="youtubeId" name="youtubeId" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div>
            <label for="duration" class="block text-brand-muted font-sans text-sm mb-2">Duracion</label>
            <input type="text" id="duration" name="duration" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div>
            <label for="imageFile" class="block text-brand-muted font-sans text-sm mb-2">Imagen del curso</label>
            <input type="file" id="imageFile" name="imageFile" accept="image/*" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
          </div>
          <div class="md:col-span-2">
            <label for="description" class="block text-brand-muted font-sans text-sm mb-2">Descripcion</label>
            <textarea id="description" name="description" rows="4" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue"></textarea>
          </div>
        </div>
        <button type="submit" class="mt-6 w-full md:w-auto bg-brand-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider">
          Agregar curso
        </button>
        <p id="form-message" class="text-sm mt-4"></p>
      </form>

      <h2 class="text-2xl font-display font-bold text-white mb-6">Cursos actuales</h2>
      <div id="course-list" class="grid grid-cols-1 gap-4">
        {lessons.map((lesson, index) => (
          <div class="bg-brand-card border border-brand-border rounded-xl p-4 flex items-center gap-4">
            <img src={lesson.imageUrl} alt={lesson.title} class="w-20 h-20 rounded-lg object-cover">
            <div class="flex-1">
              <p class="text-white font-bold">{lesson.title}</p>
              <p class="text-brand-muted text-sm">{lesson.price}</p>
            </div>
            <div class="flex items-center gap-2">
              <button class="edit-btn bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="base" data-index={index}>Editar</button>
              <button class="delete-btn bg-red-600 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="base" data-index={index} data-slug={lesson.slug}>Eliminar</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  </main>

  <div id="edit-course-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70">
    <div class="w-full max-w-3xl bg-brand-card border border-brand-border rounded-2xl p-6 md:p-8">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-display font-bold text-white">Editar curso</h2>
        <button id="close-edit-course-modal" type="button" class="text-brand-muted hover:text-white text-xl">&times;</button>
      </div>

      <form id="edit-course-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="edit-title" class="block text-brand-muted font-sans text-sm mb-2">Titulo del curso</label>
            <input id="edit-title" name="title" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div>
            <label for="edit-price" class="block text-brand-muted font-sans text-sm mb-2">Precio</label>
            <input id="edit-price" name="price" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div>
            <label for="edit-category" class="block text-brand-muted font-sans text-sm mb-2">Categoria</label>
            <select id="edit-category" name="category" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
              <option value="Formacion Especializada · Metodo HITRO Adultos">Formacion Especializada · Metodo HITRO Adultos</option>
              <option value="Formacion Especializada · Metodo HITRO Femenino">Formacion Especializada · Metodo HITRO Femenino</option>
              <option value="Formacion Especializada · Metodo HITRO Infantil">Formacion Especializada · Metodo HITRO Infantil</option>
            </select>
          </div>
          <div>
            <label for="edit-slug" class="block text-brand-muted font-sans text-sm mb-2">Slug</label>
            <input id="edit-slug" name="slug" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div>
            <label for="edit-youtube" class="block text-brand-muted font-sans text-sm mb-2">ID de YouTube</label>
            <input id="edit-youtube" name="youtubeId" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div>
            <label for="edit-duration" class="block text-brand-muted font-sans text-sm mb-2">Duracion</label>
            <input id="edit-duration" name="duration" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div class="md:col-span-2">
            <label for="edit-image-file" class="block text-brand-muted font-sans text-sm mb-2">Imagen del curso (subir nueva opcional)</label>
            <input id="edit-image-file" name="imageFile" type="file" accept="image/*" class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
          </div>
          <div class="md:col-span-2">
            <img id="edit-image-preview" src="" alt="Previsualizacion" class="hidden w-28 h-28 object-cover rounded-lg border border-brand-border">
          </div>
          <div class="md:col-span-2">
            <label for="edit-description" class="block text-brand-muted font-sans text-sm mb-2">Descripcion</label>
            <textarea id="edit-description" name="description" rows="4" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white"></textarea>
          </div>
        </div>

        <div class="flex flex-col md:flex-row gap-3 pt-2">
          <button id="save-edit-course" type="submit" class="bg-brand-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 uppercase tracking-wider">Guardar cambios</button>
          <button id="cancel-edit-course" type="button" class="bg-brand-border text-white font-bold py-3 px-8 rounded-lg hover:bg-neutral-700 uppercase tracking-wider">Cancelar</button>
        </div>
        <p id="edit-form-message" class="text-sm"></p>
      </form>
    </div>
  </div>
</Layout>

<script id="base-courses-data" type="application/json" set:html={JSON.stringify(lessons)}></script>
<script>
  import { useAdminPanel } from '../../hooks/useAdminPanel';
  import { useAuth } from '../../hooks/useAuth';
  import { useToast } from '../../hooks/useToast';

  type CoursePayload = {
    title: string;
    price: string;
    category: string;
    slug: string;
    youtubeId: string;
    duration: string;
    imageUrl: string;
    description: string;
  };

  type EditSource = 'base' | 'dev';

  const auth = useAuth();
  const toast = useToast();

  if (import.meta.env.DEV && !auth.isDevAuthenticated()) {
    window.location.href = '/admin/login';
  }

  const formEl = document.getElementById('add-course-form') as HTMLFormElement | null;
  const listEl = document.getElementById('course-list');
  const messageEl = document.getElementById('form-message');
  const storageKey = 'hitro_lessons_dev';
  const panel = useAdminPanel<CoursePayload>(storageKey);
  const baseCourses = JSON.parse(document.getElementById('base-courses-data')?.textContent || '[]') as CoursePayload[];

  const editModalEl = document.getElementById('edit-course-modal');
  const editFormEl = document.getElementById('edit-course-form') as HTMLFormElement | null;
  const editMessageEl = document.getElementById('edit-form-message');
  const editImagePreview = document.getElementById('edit-image-preview') as HTMLImageElement | null;

  let editing: { source: EditSource; index: number; imageUrl: string; slug?: string } | null = null;

  function getDevCourses(): CoursePayload[] {
    return panel.getLocal();
  }

  function fileToDataUrl(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ''));
      reader.onerror = () => reject(new Error('No se pudo leer la imagen'));
      reader.readAsDataURL(file);
    });
  }

  function normalizeCourse(payload: Partial<CoursePayload>): CoursePayload {
    return {
      title: payload.title || '',
      price: payload.price || '',
      category: payload.category || 'Formacion Especializada · Metodo HITRO Adultos',
      slug: payload.slug || '',
      youtubeId: payload.youtubeId || '',
      duration: payload.duration || '',
      imageUrl: payload.imageUrl || '',
      description: payload.description || '',
    };
  }

  function closeEditModal() {
    if (!editModalEl || !editFormEl) return;
    editing = null;
    editFormEl.reset();
    if (editImagePreview) {
      editImagePreview.src = '';
      editImagePreview.classList.add('hidden');
    }
    editModalEl.classList.add('hidden');
    editModalEl.classList.remove('flex');
  }

  function openEditModal(item: CoursePayload, source: EditSource, index: number) {
    if (!editModalEl || !editFormEl) return;
    editing = { source, index, imageUrl: item.imageUrl, slug: item.slug };

    (editFormEl.elements.namedItem('title') as HTMLInputElement).value = item.title || '';
    (editFormEl.elements.namedItem('price') as HTMLInputElement).value = item.price || '';
    (editFormEl.elements.namedItem('category') as HTMLSelectElement).value = item.category || 'Formacion Especializada · Metodo HITRO Adultos';
    (editFormEl.elements.namedItem('slug') as HTMLInputElement).value = item.slug || '';
    (editFormEl.elements.namedItem('youtubeId') as HTMLInputElement).value = item.youtubeId || '';
    (editFormEl.elements.namedItem('duration') as HTMLInputElement).value = item.duration || '';
    (editFormEl.elements.namedItem('description') as HTMLTextAreaElement).value = item.description || '';

    if (editImagePreview && item.imageUrl) {
      editImagePreview.src = item.imageUrl;
      editImagePreview.classList.remove('hidden');
    }

    if (editMessageEl) editMessageEl.textContent = '';
    editModalEl.classList.remove('hidden');
    editModalEl.classList.add('flex');
  }

  function buildItemHtml(course: CoursePayload, source: EditSource, index: number, slug: string): string {
    return `
      <div class="bg-brand-card border border-brand-border rounded-xl p-4 flex items-center gap-4" data-dev-course="${source === 'dev' ? 'true' : 'false'}">
        <img src="${course.imageUrl || ''}" alt="${course.title || ''}" class="w-20 h-20 rounded-lg object-cover">
        <div class="flex-1">
          <p class="text-white font-bold">${course.title || ''}</p>
          <p class="text-brand-muted text-sm">${course.price || ''}</p>
        </div>
        <div class="flex items-center gap-2">
          <button class="edit-btn bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="${source}" data-index="${index}">Editar</button>
          <button class="delete-btn bg-red-600 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="${source}" data-index="${index}" data-slug="${slug}">Eliminar</button>
        </div>
      </div>
    `;
  }

  function renderCourses() {
    if (!listEl) return;

    const baseHtml = baseCourses.map((course, index) => buildItemHtml(normalizeCourse(course), 'base', index, course.slug || '')).join('');
    const devHtml = panel.getLocal().map((course, index) => {
      const normalized = normalizeCourse(course);
      return buildItemHtml(normalized, 'dev', index, normalized.slug || `dev-${index}`);
    }).join('');

    listEl.innerHTML = `${baseHtml}${devHtml}`;
  }

  async function getCoursePayloadFromAddForm(form: HTMLFormElement): Promise<CoursePayload | null> {
    const imageInput = form.elements.namedItem('imageFile') as HTMLInputElement;
    const selectedFile = imageInput?.files?.[0];

    if (!selectedFile) {
      toast.error('Debes subir una imagen para el curso');
      return null;
    }

    const imageUrl = await fileToDataUrl(selectedFile);
    return normalizeCourse({
      title: (form.elements.namedItem('title') as HTMLInputElement).value,
      price: (form.elements.namedItem('price') as HTMLInputElement).value,
      category: (form.elements.namedItem('category') as HTMLSelectElement).value,
      slug: (form.elements.namedItem('slug') as HTMLInputElement).value,
      youtubeId: (form.elements.namedItem('youtubeId') as HTMLInputElement).value,
      duration: (form.elements.namedItem('duration') as HTMLInputElement).value,
      description: (form.elements.namedItem('description') as HTMLTextAreaElement).value,
      imageUrl,
    });
  }

  async function getCoursePayloadFromEditForm(form: HTMLFormElement): Promise<CoursePayload | null> {
    if (!editing) return null;

    const imageInput = form.elements.namedItem('imageFile') as HTMLInputElement;
    const selectedFile = imageInput?.files?.[0];
    const imageUrl = selectedFile ? await fileToDataUrl(selectedFile) : editing.imageUrl;

    if (!imageUrl) {
      toast.error('El curso necesita una imagen');
      return null;
    }

    return normalizeCourse({
      title: (form.elements.namedItem('title') as HTMLInputElement).value,
      price: (form.elements.namedItem('price') as HTMLInputElement).value,
      category: (form.elements.namedItem('category') as HTMLSelectElement).value,
      slug: (form.elements.namedItem('slug') as HTMLInputElement).value,
      youtubeId: (form.elements.namedItem('youtubeId') as HTMLInputElement).value,
      duration: (form.elements.namedItem('duration') as HTMLInputElement).value,
      description: (form.elements.namedItem('description') as HTMLTextAreaElement).value,
      imageUrl,
    });
  }

  async function handleDelete(source: EditSource, slug: string, index: number) {
    if (!confirm('Seguro que quieres eliminar este curso?')) return;

    if (source === 'dev' && import.meta.env.DEV) {
      panel.deleteLocal(index);
      toast.success('Curso eliminado');
      renderCourses();
      return;
    }

    const result = await panel.send(`/courses?slug=${encodeURIComponent(slug)}`, 'DELETE');
    if (result.ok) {
      toast.success('Curso eliminado');
      window.location.reload();
    } else {
      toast.error('No se pudo eliminar el curso');
    }
  }

  formEl?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target as HTMLFormElement;
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    if (!messageEl || submitBtn?.disabled) return;

    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

    try {
      const payload = await getCoursePayloadFromAddForm(form);
      if (!payload) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        return;
      }

      if (import.meta.env.DEV) {
        panel.addLocal(payload);
        messageEl.textContent = 'Curso guardado en modo DEV.';
        messageEl.className = 'text-green-500 text-sm mt-4';
        toast.success('Curso guardado');
        form.reset();
        renderCourses();
        return;
      }

      const result = await panel.send(
        '/courses',
        'POST',
        new URLSearchParams(payload as Record<string, string>).toString(),
        { 'Content-Type': 'application/x-www-form-urlencoded' }
      );

      if (result.ok) {
        messageEl.textContent = 'Curso agregado correctamente. Recargando...';
        messageEl.className = 'text-green-500 text-sm mt-4';
        toast.success('Curso guardado');
        form.reset();
        window.setTimeout(() => window.location.reload(), 1200);
      } else {
        messageEl.textContent = `Error al agregar curso: ${result.message}`;
        messageEl.className = 'text-red-500 text-sm mt-4';
        toast.error('No se pudo guardar el curso');
      }
    } catch (error) {
      console.error(error);
      messageEl.textContent = 'No se pudo procesar la imagen del curso.';
      messageEl.className = 'text-red-500 text-sm mt-4';
      toast.error('No se pudo guardar el curso');
    } finally {
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
    }
  });

  listEl?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    const deleteBtn = target.closest('.delete-btn') as HTMLElement | null;
    if (deleteBtn) {
      const source = (deleteBtn.getAttribute('data-source') || 'base') as EditSource;
      const slug = deleteBtn.getAttribute('data-slug') || '';
      const index = Number.parseInt(deleteBtn.getAttribute('data-index') || '-1', 10);
      handleDelete(source, slug, index);
      return;
    }

    const editBtn = target.closest('.edit-btn') as HTMLElement | null;
    if (!editBtn) return;

    const source = (editBtn.getAttribute('data-source') || 'base') as EditSource;
    const index = Number.parseInt(editBtn.getAttribute('data-index') || '-1', 10);
    if (index < 0) return;

    const current = source === 'dev' ? getDevCourses()[index] : normalizeCourse(baseCourses[index]);
    if (!current) return;
    openEditModal(normalizeCourse(current), source, index);
  });

  editFormEl?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!editing || !editFormEl || !editMessageEl) return;

    const submitBtn = editFormEl.querySelector('button[type="submit"]') as HTMLButtonElement | null;
    if (submitBtn?.disabled) return;
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-60', 'cursor-not-allowed');

    try {
      const payload = await getCoursePayloadFromEditForm(editFormEl);
      if (!payload) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        return;
      }

      if (import.meta.env.DEV && editing.source === 'dev') {
        const existing = getDevCourses();
        if (!existing[editing.index]) {
          editMessageEl.textContent = 'No se encontro el curso a editar.';
          editMessageEl.className = 'text-red-500 text-sm';
          return;
        }
        existing[editing.index] = payload;
        panel.setLocal(existing);
        editMessageEl.textContent = 'Curso actualizado en modo DEV.';
        editMessageEl.className = 'text-green-500 text-sm';
        toast.success('Curso actualizado');
        renderCourses();
        window.setTimeout(closeEditModal, 500);
        return;
      }

      const result = await panel.send(
        '/courses',
        'PUT',
        JSON.stringify({ index: editing.index, ...payload }),
        { 'Content-Type': 'application/json' }
      );

      if (result.ok) {
        editMessageEl.textContent = 'Curso actualizado. Recargando...';
        editMessageEl.className = 'text-green-500 text-sm';
        toast.success('Curso actualizado');
        window.setTimeout(() => window.location.reload(), 1200);
      } else {
        editMessageEl.textContent = result.message || 'Error al actualizar curso.';
        editMessageEl.className = 'text-red-500 text-sm';
        toast.error('No se pudo actualizar el curso');
      }
    } catch (error) {
      console.error(error);
      editMessageEl.textContent = 'No se pudo leer la imagen del curso.';
      editMessageEl.className = 'text-red-500 text-sm';
      toast.error('No se pudo actualizar el curso');
    } finally {
      submitBtn.disabled = false;
      submitBtn.classList.remove('opacity-60', 'cursor-not-allowed');
    }
  });

  const editImageInput = document.getElementById('edit-image-file') as HTMLInputElement | null;
  editImageInput?.addEventListener('change', async () => {
    const selectedFile = editImageInput.files?.[0];
    if (!selectedFile || !editImagePreview) return;
    const imageUrl = await fileToDataUrl(selectedFile);
    editImagePreview.src = imageUrl;
    editImagePreview.classList.remove('hidden');
  });

  document.getElementById('close-edit-course-modal')?.addEventListener('click', closeEditModal);
  document.getElementById('cancel-edit-course')?.addEventListener('click', closeEditModal);
  editModalEl?.addEventListener('click', (e) => {
    if (e.target === editModalEl) closeEditModal();
  });

  renderCourses();
</script>
