---
// src/pages/admin/courses.astro
import Layout from '../../layouts/Layout.astro';
import { lessons } from '../../data/lessons';
import { Shield, Zap, PlayCircle } from 'lucide-astro';

export const prerender = false;

const session = Astro.cookies.get('session');
const isDev = import.meta.env.DEV;

if (!isDev && session?.value !== 'admin') {
  return Astro.redirect('/admin/login');
}

const iconMap = {
    Shield,
    Zap,
    PlayCircle
}

---

<Layout title="Manage Courses | HITRO">
    <main class="py-12 bg-brand-bg min-h-screen">
        <div class="max-w-4xl mx-auto px-4">
            <a href="/admin" class="text-brand-muted hover:text-white inline-block mb-6">&larr; Back to Dashboard</a>
            <h1 class="text-4xl font-display font-black text-white uppercase mb-8">Manage Courses</h1>

            <!-- Add Course Form -->
            <form id="add-course-form" class="bg-brand-card border border-brand-border rounded-[2rem] p-8 mb-12">
                <h2 class="text-2xl font-display font-bold text-white mb-6">Add New Course</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="title" class="block text-brand-muted font-sans text-sm mb-2">Course Title</label>
                        <input type="text" id="title" name="title" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="price" class="block text-brand-muted font-sans text-sm mb-2">Price (e.g., 49.99€)</label>
                        <input type="text" id="price" name="price" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="category" class="block text-brand-muted font-sans text-sm mb-2">Category</label>
                        <input type="text" id="category" name="category" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                     <div>
                        <label for="slug" class="block text-brand-muted font-sans text-sm mb-2">Slug</label>
                        <input type="text" id="slug" name="slug" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                     <div>
                        <label for="youtubeId" class="block text-brand-muted font-sans text-sm mb-2">Youtube ID</label>
                        <input type="text" id="youtubeId" name="youtubeId" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                      <div>
                        <label for="duration" class="block text-brand-muted font-sans text-sm mb-2">Duration</label>
                        <input type="text" id="duration" name="duration" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="imageFile" class="block text-brand-muted font-sans text-sm mb-2">Course Image (upload an image)</label>
                        <input type="file" id="imageFile" name="imageFile" accept="image/*" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block text-brand-muted font-sans text-sm mb-2">Description</label>
                        <textarea id="description" name="description" rows="4" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue"></textarea>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full md:w-auto bg-brand-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider">
                    Add Course
                </button>
                <p id="form-message" class="text-sm mt-4"></p>
            </form>

            <!-- Existing Courses List -->
            <h2 class="text-2xl font-display font-bold text-white mb-6">Existing Courses</h2>
            <div id="course-list" class="grid grid-cols-1 gap-4">
                {lessons.map((lesson, index) => (
                    <div class="bg-brand-card border border-brand-border rounded-xl p-4 flex items-center gap-4">
                        <img src={lesson.imageUrl} alt={lesson.title} class="w-20 h-20 rounded-lg object-cover">
                        <div class="flex-1">
                            <p class="text-white font-bold">{lesson.title}</p>
                            <p class="text-brand-muted text-sm">{lesson.price}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="edit-btn bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded-lg" data-index={index}>Editar</button>
                            <button class="delete-btn bg-red-600 text-white text-xs font-bold px-3 py-2 rounded-lg" data-slug={lesson.slug}>Eliminar</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </main>
</Layout>

<script>
    if (import.meta.env.DEV) {
        const session = localStorage.getItem('admin_session');
        if (session !== 'admin') {
            window.location.href = '/admin/login';
        }
    }

    const formEl = document.getElementById('add-course-form') as HTMLFormElement | null;
    const listEl = document.getElementById('course-list');
    const storageKey = 'hitro_lessons_dev';

    async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const messageEl = document.getElementById('form-message');

        if (!messageEl) {
            console.error('Could not find form-message element');
            return;
        }

        const response = await fetch('/api/courses', {
            method: 'POST',
            body: formData,
        });

        if (response.ok) {
            messageEl.textContent = 'Course added successfully! Refreshing...';
            messageEl.className = 'text-green-500 text-sm mt-4';
            form.reset();
            setTimeout(() => window.location.reload(), 2000);
        } else {
            const text = await response.text();
            messageEl.textContent = 'Error adding course: ' + text;
            messageEl.className = 'text-red-500 text-sm mt-4';
        }
    }

    async function handleDelete(slug) {
        if (!confirm('Are you sure you want to delete this course?')) return;

        const response = await fetch(`/api/courses?slug=${slug}`, {
            method: 'DELETE',
        });

        if (response.ok) {
            alert('Course deleted successfully! Refreshing...');
            window.location.reload();
        } else {
            const text = await response.text();
            alert('Error deleting course: ' + text);
        }
    }
    
    async function handleEdit(index, newPrice) {
        const params = new URLSearchParams();
        params.append('index', index);
        params.append('newPrice', newPrice);

        const response = await fetch('/api/courses', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: params.toString(),
        });

        if (response.ok) {
            alert('Price updated successfully! Refreshing...');
            window.location.reload();
        } else {
            const text = await response.text();
            alert('Error updating price: ' + text);
        }
    }


    formEl?.addEventListener('submit', handleFormSubmit);

    listEl?.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.classList.contains('delete-btn')) {
            const slug = target.dataset.slug;
            if (slug) handleDelete(slug);
        }
        if (target.classList.contains('edit-btn')) {
            const index = parseInt(target.dataset.index, 10);
            const newPrice = prompt('Enter the new price (e.g., 59.99€):');
            if (newPrice) {
                handleEdit(index, newPrice);
            }
        }
    });

</script>
