---
// src/pages/admin/videos.astro
import Layout from '../../layouts/Layout.astro';
import { videos } from '../../data/videos';

export const prerender = false;

const session = Astro.cookies.get('session');
const isDev = import.meta.env.DEV;

if (!isDev && session?.value !== 'admin') {
  return Astro.redirect('/admin/login');
}
---

<Layout title="Gestionar Videos | HITRO">
    <main class="py-12 bg-brand-bg min-h-screen">
        <div class="max-w-4xl mx-auto px-4">
            <a href="/admin" class="text-brand-muted hover:text-white inline-block mb-6">&larr; Volver al panel</a>
            <h1 class="text-4xl font-display font-black text-white uppercase mb-8">Gestionar videos</h1>

            <form id="add-video-form" class="bg-brand-card border border-brand-border rounded-[2rem] p-8 mb-12">
                <h2 class="text-2xl font-display font-bold text-white mb-6">Agregar nuevo video</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="title" class="block text-brand-muted font-sans text-sm mb-2">Titulo del video</label>
                        <input type="text" id="title" name="title" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="category" class="block text-brand-muted font-sans text-sm mb-2">Categoria</label>
                        <input type="text" id="category" name="category" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="youtubeId" class="block text-brand-muted font-sans text-sm mb-2">ID del video en YouTube</label>
                        <input type="text" id="youtubeId" name="youtubeId" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div>
                        <label for="duration" class="block text-brand-muted font-sans text-sm mb-2">Duracion (ejemplo: 12:45)</label>
                        <input type="text" id="duration" name="duration" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div class="md:col-span-2">
                        <label for="imageUrl" class="block text-brand-muted font-sans text-sm mb-2">URL de miniatura</label>
                        <input type="url" id="imageUrl" name="imageUrl" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue">
                    </div>
                    <div class="md:col-span-2">
                        <label for="description" class="block text-brand-muted font-sans text-sm mb-2">Descripcion</label>
                        <textarea id="description" name="description" rows="4" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-brand-blue"></textarea>
                    </div>
                </div>
                <button type="submit" class="mt-6 w-full md:w-auto bg-brand-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 transition-all duration-300 uppercase tracking-wider">
                    Agregar video
                </button>
                <p id="form-message" class="text-sm mt-4"></p>
            </form>

            <h2 class="text-2xl font-display font-bold text-white mb-6">Videos actuales</h2>
            <div id="video-list" class="grid grid-cols-1 gap-4">
                {videos.map((lesson, index) => (
                    <div class="bg-brand-card border border-brand-border rounded-xl p-4 flex items-center gap-4">
                        <img src={lesson.imageUrl} alt={lesson.title} class="w-20 h-20 rounded-lg object-cover">
                        <div class="flex-1">
                            <p class="text-white font-bold">{lesson.title}</p>
                            <p class="text-brand-muted text-sm">{lesson.category}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="edit-btn bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="base" data-index={index}>Editar</button>
                            <button class="delete-dev hidden bg-red-600 text-white text-xs font-bold px-3 py-2 rounded-lg">Eliminar</button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    </main>

    <div id="edit-video-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/70">
        <div class="w-full max-w-3xl bg-brand-card border border-brand-border rounded-2xl p-6 md:p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-display font-bold text-white">Editar video</h2>
                <button id="close-edit-video-modal" type="button" class="text-brand-muted hover:text-white text-xl">&times;</button>
            </div>

            <form id="edit-video-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="edit-title" class="block text-brand-muted font-sans text-sm mb-2">Titulo del video</label>
                        <input id="edit-title" name="title" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-brand-muted font-sans text-sm mb-2">Categoria</label>
                        <input id="edit-category" name="category" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label for="edit-youtube" class="block text-brand-muted font-sans text-sm mb-2">ID del video en YouTube</label>
                        <input id="edit-youtube" name="youtubeId" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label for="edit-duration" class="block text-brand-muted font-sans text-sm mb-2">Duracion</label>
                        <input id="edit-duration" name="duration" type="text" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-image-url" class="block text-brand-muted font-sans text-sm mb-2">URL de miniatura</label>
                        <input id="edit-image-url" name="imageUrl" type="url" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white">
                    </div>
                    <div class="md:col-span-2">
                        <label for="edit-description" class="block text-brand-muted font-sans text-sm mb-2">Descripcion</label>
                        <textarea id="edit-description" name="description" rows="4" required class="w-full bg-[#050505] border border-brand-border rounded-lg px-4 py-3 text-white"></textarea>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3 pt-2">
                    <button id="save-edit-video" type="submit" class="bg-brand-blue text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-600 uppercase tracking-wider">Guardar cambios</button>
                    <button id="cancel-edit-video" type="button" class="bg-brand-border text-white font-bold py-3 px-8 rounded-lg hover:bg-neutral-700 uppercase tracking-wider">Cancelar</button>
                </div>
                <p id="edit-form-message" class="text-sm"></p>
            </form>
        </div>
    </div>
</Layout>

<script id="base-videos-data" type="application/json" set:html={JSON.stringify(videos)}></script>
<script>
    import { useAdminPanel } from '../../hooks/useAdminPanel';
    import { useAuth } from '../../hooks/useAuth';
    import { useToast } from '../../hooks/useToast';

    const auth = useAuth();
    const toast = useToast();

    if (import.meta.env.DEV) {
        if (!auth.isDevAuthenticated()) {
            window.location.href = '/admin/login';
        }
    }

    const addFormEl = document.getElementById('add-video-form') as HTMLFormElement | null;
    const listEl = document.getElementById('video-list');
    const messageEl = document.getElementById('form-message');
    const storageKey = 'hitro_videos_dev';
    const panel = useAdminPanel<VideoPayload>(storageKey);
    const baseVideos = JSON.parse(document.getElementById('base-videos-data')?.textContent || '[]');

    const editModalEl = document.getElementById('edit-video-modal');
    const editFormEl = document.getElementById('edit-video-form') as HTMLFormElement | null;
    const editMessageEl = document.getElementById('edit-form-message');

    type VideoPayload = {
        title: string;
        category: string;
        youtubeId: string;
        duration: string;
        imageUrl: string;
        description: string;
    };

    type EditSource = 'base' | 'dev';
    let editing: { source: EditSource; index: number } | null = null;

    function getDevVideos(): VideoPayload[] {
        return panel.getLocal();
    }

    function openEditModal(item: VideoPayload, source: EditSource, index: number) {
        if (!editFormEl || !editModalEl) return;
        editing = { source, index };
        (editFormEl.elements.namedItem('title') as HTMLInputElement).value = item.title || '';
        (editFormEl.elements.namedItem('category') as HTMLInputElement).value = item.category || '';
        (editFormEl.elements.namedItem('youtubeId') as HTMLInputElement).value = item.youtubeId || '';
        (editFormEl.elements.namedItem('duration') as HTMLInputElement).value = item.duration || '';
        (editFormEl.elements.namedItem('imageUrl') as HTMLInputElement).value = item.imageUrl || '';
        (editFormEl.elements.namedItem('description') as HTMLTextAreaElement).value = item.description || '';
        if (editMessageEl) editMessageEl.textContent = '';
        editModalEl.classList.remove('hidden');
        editModalEl.classList.add('flex');
    }

    function closeEditModal() {
        if (!editModalEl || !editFormEl) return;
        editing = null;
        editFormEl.reset();
        editModalEl.classList.add('hidden');
        editModalEl.classList.remove('flex');
    }

    function renderDevVideos() {
        if (!listEl) return;
        const devVideos = getDevVideos();
        listEl.querySelectorAll('[data-dev-video]').forEach((el) => el.remove());

        devVideos.forEach((video, index) => {
            const item = document.createElement('div');
            item.className = 'bg-brand-card border border-brand-border rounded-xl p-4 flex items-center gap-4';
            item.setAttribute('data-dev-video', 'true');
            item.innerHTML = `
                <img src="${video.imageUrl || ''}" alt="${video.title || ''}" class="w-20 h-20 rounded-lg object-cover">
                <div class="flex-1">
                    <p class="text-white font-bold">${video.title || ''}</p>
                    <p class="text-brand-muted text-sm">${video.category || ''}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button class="edit-btn bg-yellow-500 text-white text-xs font-bold px-3 py-2 rounded-lg" data-source="dev" data-index="${index}">Editar</button>
                    <button class="delete-dev bg-red-600 text-white text-xs font-bold px-3 py-2 rounded-lg" data-index="${index}">Eliminar</button>
                </div>
            `;
            listEl.appendChild(item);
        });
    }

    if (import.meta.env.DEV) {
        renderDevVideos();
    }

    listEl?.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        const deleteBtn = target.closest('.delete-dev') as HTMLElement | null;
        if (deleteBtn && import.meta.env.DEV) {
            const index = Number.parseInt(deleteBtn.getAttribute('data-index') || '-1', 10);
            if (index < 0) return;
            panel.deleteLocal(index);
            toast.success('Video eliminado');
            renderDevVideos();
            return;
        }

        const editBtn = target.closest('.edit-btn') as HTMLElement | null;
        if (!editBtn) return;

        const index = Number.parseInt(editBtn.getAttribute('data-index') || '-1', 10);
        const source = (editBtn.getAttribute('data-source') || 'base') as EditSource;
        if (index < 0) return;

        const current = source === 'dev' ? getDevVideos()[index] : baseVideos[index];
        if (!current) return;
        openEditModal(current, source, index);
    });

    addFormEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const formData = new FormData(form);
        const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;
        if (!messageEl) return;
        if (submitBtn?.disabled) return;
        if (submitBtn) submitBtn.disabled = true;
        submitBtn?.classList.add('opacity-60', 'cursor-not-allowed');

        const payload = Object.fromEntries(Array.from(formData.entries()).map(([k, v]) => [k, String(v)])) as VideoPayload;

        if (import.meta.env.DEV) {
            panel.addLocal(payload);
            messageEl.textContent = 'Video guardado en modo DEV.';
            messageEl.className = 'text-green-500 text-sm mt-4';
            toast.success('Video guardado');
            form.reset();
            renderDevVideos();
            if (submitBtn) submitBtn.disabled = false;
            submitBtn?.classList.remove('opacity-60', 'cursor-not-allowed');
            return;
        }

        const result = await panel.send(
            '/videos',
            'POST',
            new URLSearchParams(payload).toString(),
            { 'Content-Type': 'application/x-www-form-urlencoded' }
        );

        if (result.ok) {
            messageEl.textContent = 'Video agregado correctamente. Recargando...';
            messageEl.className = 'text-green-500 text-sm mt-4';
            toast.success('Video guardado');
            form.reset();
            setTimeout(() => window.location.reload(), 2000);
        } else {
            messageEl.textContent = result.message || 'Error al agregar video.';
            messageEl.className = 'text-red-500 text-sm mt-4';
            toast.error('No se pudo guardar el video');
        }
        if (submitBtn) submitBtn.disabled = false;
        submitBtn?.classList.remove('opacity-60', 'cursor-not-allowed');
    });

    editFormEl?.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!editing || !editMessageEl) return;
        const submitBtn = editFormEl.querySelector('button[type="submit"]') as HTMLButtonElement | null;
        if (submitBtn?.disabled) return;
        if (submitBtn) submitBtn.disabled = true;
        submitBtn?.classList.add('opacity-60', 'cursor-not-allowed');

        const formData = new FormData(editFormEl);
        const payload = Object.fromEntries(Array.from(formData.entries()).map(([k, v]) => [k, String(v)])) as VideoPayload;

        if (import.meta.env.DEV && editing.source === 'dev') {
            const existing = getDevVideos();
            if (!existing[editing.index]) {
                editMessageEl.textContent = 'No se encontro el video a editar.';
                editMessageEl.className = 'text-red-500 text-sm';
                if (submitBtn) submitBtn.disabled = false;
                submitBtn?.classList.remove('opacity-60', 'cursor-not-allowed');
                return;
            }
            existing[editing.index] = payload;
            panel.setLocal(existing);
            editMessageEl.textContent = 'Video actualizado en modo DEV.';
            editMessageEl.className = 'text-green-500 text-sm';
            toast.success('Video actualizado');
            renderDevVideos();
            setTimeout(closeEditModal, 500);
            if (submitBtn) submitBtn.disabled = false;
            submitBtn?.classList.remove('opacity-60', 'cursor-not-allowed');
            return;
        }

        const result = await panel.send(
            '/videos',
            'PUT',
            JSON.stringify({ index: editing.index, ...payload }),
            { 'Content-Type': 'application/json' }
        );

        if (result.ok) {
            editMessageEl.textContent = 'Video actualizado. Recargando...';
            editMessageEl.className = 'text-green-500 text-sm';
            toast.success('Video actualizado');
            setTimeout(() => window.location.reload(), 1200);
        } else {
            editMessageEl.textContent = result.message || 'Error al actualizar video.';
            editMessageEl.className = 'text-red-500 text-sm';
            toast.error('No se pudo actualizar el video');
        }
        if (submitBtn) submitBtn.disabled = false;
        submitBtn?.classList.remove('opacity-60', 'cursor-not-allowed');
    });

    document.getElementById('close-edit-video-modal')?.addEventListener('click', closeEditModal);
    document.getElementById('cancel-edit-video')?.addEventListener('click', closeEditModal);

    editModalEl?.addEventListener('click', (e) => {
        if (e.target === editModalEl) closeEditModal();
    });
</script>
